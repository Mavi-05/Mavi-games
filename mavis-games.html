<!-- F√ºge das hier direkt nach dem Script-Block aus Teil 1 ein -->
<script>
// =================== Subway Surfer: UI & Spiel-Elemente dynamisch einf√ºgen ===================
function injectSubwayUI() {
  // Falls schon da, nichts tun
  if (document.getElementById("game-ui")) return;

  // UI/Modals einf√ºgen
  document.body.insertAdjacentHTML("beforeend", `
    <div id="game-ui">
      <div id="score">Score: 0</div>
      <div id="coins">üí∞ 0</div>
      <div id="powerup"></div>
      <div id="highscore"></div>
      <button id="pause-btn">‚è∏Ô∏è Pause</button>
      <button id="restart-btn">üîÑ Neustart</button>
      <button id="shop-btn" style="right:170px;background:#2d2;">üõí Shop</button>
    </div>
    <div id="char-select">
      <h2>W√§hle deinen Charakter,<br><span id="char-username"></span>!</h2>
      <div id="char-list"></div>
      <div id="char-info"></div>
      <button id="char-start-btn" style="margin-top:20px;padding:12px 34px;font-size:20px;background:#0cf;color:#fff;border:none;border-radius:10px;cursor:pointer;">Los geht's!</button>
    </div>
    <div id="shop">
      <h2>Shop & Upgrades</h2>
      <div id="shop-items"></div>
      <button id="shop-close-btn" style="margin-top:20px;padding:10px 28px;font-size:17px;background:#0cf;color:#fff;border:none;border-radius:8px;cursor:pointer;">Zur√ºck</button>
    </div>
    <div id="gameover">
      <h1 style="color:#fa3;font-size:44px;margin-bottom:10px;">Game Over</h1>
      <div id="gameover-stats"></div>
      <button id="gameover-restart-btn" style="margin-top:24px;padding:14px 32px;font-size:22px;background:#0cf;color:#fff;border:none;border-radius:11px;cursor:pointer;">Nochmal!</button>
    </div>
    <div id="pause">
      <h2>Pause</h2>
      <p>Dr√ºcke <b>Fortsetzen</b> zum Weiterspielen.</p>
      <button id="pause-resume-btn" style="padding:12px 40px;margin:20px 0 0 0;font-size:20px;background:#0cf;color:#fff;border:none;border-radius:10px;cursor:pointer;">Fortsetzen</button>
    </div>
  `);
}

// =================== Subway Surfer GAME LOGIK ===================
const GAME_W = 420, GAME_H = 740;
let ctx = null, canvas = null, bgCanvas = null, bgCtx = null;
let animationFrame;
let state = "menu"; // "menu"|"charselect"|"run"|"pause"|"gameover"|"shop"
let runTime = 0, runSpeed = 6, level = 1;
let score = 0, coins = 0, hiscore = 0, collectedCoins = 0;
let powerup = null, powerupTimer = 0;
let lastLane = 1, lanes = [GAME_W/6, GAME_W/2, 5*GAME_W/6];
let touchStartX = null, pausedFrame = null;
let gameSettings = {
  player: 0,
  upgrades: { magnet: 0, shield: 0, jetpack: 0, coin: 0 },
  coins: 0,
  hiscore: 0
};
const CHARACTERS = [
  { name: "Max", color: "#0cf", emoji: "üßë‚Äçü¶±", desc: "Standard-Runner. Leichtf√º√üig." },
  { name: "Luna", color: "#f0c", emoji: "üëß", desc: "Extra schnelle Spr√ºnge." },
  { name: "Robo", color: "#fc0", emoji: "ü§ñ", desc: "Startet mit Schild." },
  { name: "Ghosty", color: "#fff", emoji: "üëª", desc: "Kann Hindernisse manchmal durchdringen." }
];
const POWERUPS = [
  { key:"magnet", name:"Magnet", color:"#f22", emoji:"üß≤", desc:"Zieht M√ºnzen heran." },
  { key:"jetpack", name:"Jetpack", color:"#0f7", emoji:"üöÄ", desc:"Fliegt √ºber alles!" },
  { key:"shield", name:"Schild", color:"#0ff", emoji:"üõ°Ô∏è", desc:"Sch√ºtzt vor 1 Treffer." }
];
const SHOP_ITEMS = [
  { key:"magnet", name:"Magnet-Lvl", desc:"Magnet l√§nger aktiv.", emoji:"üß≤", cost:[60,120,280,600], max:4 },
  { key:"shield", name:"Schild-Lvl", desc:"Schild h√§lt l√§nger.", emoji:"üõ°Ô∏è", cost:[70,130,340,700], max:4 },
  { key:"jetpack", name:"Jetpack-Lvl", desc:"Jetpack l√§nger aktiv.", emoji:"üöÄ", cost:[90,180,400,800], max:4 },
  { key:"coin", name:"Coin-Multi", desc:"Mehr M√ºnzen pro Run.", emoji:"üí∞", cost:[100,220,520,1200], max:4 }
];
// Sounds (Base64, Dummy-Sounds f√ºr Demo)
const SFX = {
  coin: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YYwAAABhYWEAAP9aQAAAFgAA/w=='),
  jump: new Audio('data:audio/wav;base64,UklGRiwAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YUgAAACAgACAgACAgA=='),
  crash: new Audio('data:audio/wav;base64,UklGRtAAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YUAAAABhYQAA/1pAAABYAAD/'),
  powerup: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YYwAAABhYWEAAP9aQAAAFgAA/w=='),
  button: new Audio('data:audio/wav;base64,UklGRiwAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YUgAAACAgACAgACAgA==')
};
const BGM = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YYwAAABhYWEAAP9aQAAAFgAA/w==');
BGM.loop = true; BGM.volume = 0.22;

// Ingame-Objekte
let player = null, obstacles = [], coinsArr = [], powerupsArr = [];

// ========== SPIELSTART ===============
function startSubwaySurfer() {
  injectSubwayUI();
  canvas = document.getElementById("game-canvas");
  ctx = canvas.getContext("2d");
  canvas.width = GAME_W; canvas.height = GAME_H;
  // Parallax-Hintergrund f√ºr den Style
  bgCanvas = document.getElementById("canvas-bg");
  bgCtx = bgCanvas.getContext("2d");
  bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
  window.addEventListener("resize", ()=> {
    bgCanvas.width = window.innerWidth;
    bgCanvas.height = window.innerHeight;
  });
  // Reset State
  runTime = 0; score = 0; coins = 0; collectedCoins = 0; level = 1;
  powerup = null; powerupTimer = 0; lastLane = 1;
  player = null; obstacles = []; coinsArr = []; powerupsArr = [];
  // Highscore laden
  gameSettings = JSON.parse(localStorage.getItem("mavisgames_settings")||"null") || gameSettings;
  hiscore = gameSettings.hiscore||0;
  // UI/Modals initialisieren
  document.getElementById("game-ui").style.display = "block";
  document.getElementById("gameover").classList.remove("show");
  document.getElementById("pause").classList.remove("show");
  document.getElementById("shop").classList.remove("show");
  document.getElementById("char-select").classList.add("show");
  document.getElementById("char-username").textContent = userName;
  renderCharSelect();
  // Buttons
  document.getElementById("char-start-btn").onclick = () => {
    SFX.button.play();
    document.getElementById("char-select").classList.remove("show");
    startGame();
  };
  document.getElementById("pause-btn").onclick = pauseGame;
  document.getElementById("restart-btn").onclick = () => { SFX.button.play(); startSubwaySurfer(); };
  document.getElementById("shop-btn").onclick = showShop;
  document.getElementById("shop-close-btn").onclick = hideShop;
  document.getElementById("gameover-restart-btn").onclick = () => { SFX.button.play(); startSubwaySurfer(); };
  document.getElementById("pause-resume-btn").onclick = resumeGame;
  // UI updaten
  updateGameUI();
}
// ========== CHARAKTERAUSWAHL ==========
function renderCharSelect() {
  const list = document.getElementById("char-list");
  list.innerHTML = "";
  CHARACTERS.forEach((c, idx) => {
    const div = document.createElement("div");
    div.className = "char-icon" + (idx===gameSettings.player?" selected":"");
    div.innerHTML = `<span style="font-size:40px">${c.emoji}</span>`;
    div.onclick = () => {
      document.querySelectorAll('.char-icon').forEach(e=>e.classList.remove('selected'));
      div.classList.add("selected");
      gameSettings.player = idx;
      document.getElementById("char-info").innerHTML = `<div class='char-name'>${c.name}</div><div style="color:#aaa;font-size:15px;">${c.desc}</div>`;
    };
    list.appendChild(div);
  });
  // Standard-Auswahl
  document.getElementById("char-info").innerHTML =
    `<div class='char-name'>${CHARACTERS[gameSettings.player].name}</div>
     <div style="color:#aaa;font-size:15px;">${CHARACTERS[gameSettings.player].desc}</div>`;
}
// ========== SHOP ==========
function showShop() {
  SFX.button.play();
  document.getElementById("shop").classList.add("show");
  const itemsDiv = document.getElementById("shop-items");
  itemsDiv.innerHTML = "";
  SHOP_ITEMS.forEach((item, idx) => {
    let level = gameSettings.upgrades[item.key]||0;
    let nextLevel = Math.min(level+1, item.max);
    let cost = item.cost[level]||"-";
    const btn = document.createElement("button");
    btn.innerText = level>=item.max?"MAX":`Kaufen (${cost}üí∞)`;
    btn.className = "shop-btn-buy";
    btn.disabled = (level>=item.max)||(gameSettings.coins<cost);
    btn.onclick = () => {
      if (gameSettings.coins>=cost && level<item.max) {
        gameSettings.coins -= cost;
        gameSettings.upgrades[item.key] = nextLevel;
        localStorage.setItem("mavisgames_settings", JSON.stringify(gameSettings));
        showShop();
      }
    };
    itemsDiv.innerHTML += `
      <div class="shop-item">
        <span>${item.emoji} <b>${item.name}</b> <span style="color:#0cf">[${level}/${item.max}]</span>
        <br><small style="color:#aaa">${item.desc}</small></span>
      </div>`;
    itemsDiv.lastChild.appendChild(btn);
  });
}
function hideShop() {
  SFX.button.play();
  document.getElementById("shop").classList.remove("show");
}
// ========== GAME LOOP ==========
function startGame() {
  // Spieler
  player = {
    lane: 1,
    y: GAME_H-110,
    vy: 0,
    w: 44,
    h: 48,
    color: CHARACTERS[gameSettings.player].color,
    shield: (CHARACTERS[gameSettings.player].name==="Robo"?true:false)
  };
  obstacles = [];
  coinsArr = [];
  powerupsArr = [];
  runTime = 0;
  score = 0;
  collectedCoins = 0;
  level = 1;
  powerup = null;
  powerupTimer = 0;
  // Musik starten
  try { BGM.currentTime=0; BGM.play(); } catch(e){}
  // Start Game Loop
  state = "run";
  gameLoop();
}
function updateGameUI() {
  document.getElementById("score").textContent = `Score: ${score}`;
  document.getElementById("coins").textContent = `üí∞ ${gameSettings.coins}`;
  document.getElementById("powerup").textContent = powerup?`Aktiv: ${powerup}`:"";
  document.getElementById("highscore").textContent = `Highscore: ${hiscore}`;
}
function gameLoop() {
  if (state!=="run") return;
  ctx.clearRect(0,0,GAME_W,GAME_H);
  drawBackground();
  handleInput();
  updatePlayer();
  updateObstacles();
  updateCoins();
  updatePowerUps();
  drawPlayer();
  drawObstacles();
  drawCoins();
  drawPowerUps();
  score += 1+level*0.03;
  runTime++;
  if (runTime%400===0) level++;
  updateGameUI();
  animationFrame = requestAnimationFrame(gameLoop);
}
// ========== PAUSE & GAMEOVER ==========
function pauseGame() {
  SFX.button.play();
  state = "pause";
  document.getElementById("pause").classList.add("show");
  cancelAnimationFrame(animationFrame);
  BGM.pause();
}
function resumeGame() {
  SFX.button.play();
  state = "run";
  document.getElementById("pause").classList.remove("show");
  BGM.play();
  gameLoop();
}
function gameOver() {
  SFX.crash.play();
  state = "gameover";
  cancelAnimationFrame(animationFrame);
  BGM.pause();
  let stats = document.getElementById("gameover-stats");
  stats.innerHTML = `<b>${userName}</b>, dein Score: <b>${Math.floor(score)}</b><br>Gesammelte M√ºnzen: <b>${collectedCoins}</b>`;
  if (score>hiscore) {
    stats.innerHTML += `<br><span style="color:#0f0">Neuer Highscore!</span>`;
    hiscore = Math.floor(score);
    gameSettings.hiscore = hiscore;
  }
  gameSettings.coins += collectedCoins;
  localStorage.setItem("mavisgames_settings",JSON.stringify(gameSettings));
  document.getElementById("gameover").classList.add("show");
}
// ========== HINTERGRUND ==========
function drawBackground() {
  // Parallax
  bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
  for (let i=0;i<3;i++) {
    let y = ((runTime*runSpeed*0.1)+(i*100))%bgCanvas.height;
    bgCtx.fillStyle = ["#1e3050","#284d7a","#203c5d"][i];
    bgCtx.fillRect(0,y,bgCanvas.width,100);
    bgCtx.fillRect(0,y-bgCanvas.height,bgCanvas.width,100);
  }
  // Stra√üe
  ctx.fillStyle = "#bbb";
  ctx.fillRect(GAME_W/8,0,GAME_W*3/4,GAME_H);
  ctx.strokeStyle = "#eee";
  ctx.setLineDash([21,14]);
  for (let i = 1; i < 3; i++) {
    ctx.beginPath();
    ctx.moveTo(lanes[i],0);
    ctx.lineTo(lanes[i],GAME_H);
    ctx.stroke();
  }
  ctx.setLineDash([]);
}
// ========== SPIELER ==========
function drawPlayer() {
  ctx.save();
  ctx.translate(lanes[player.lane], player.y);
  ctx.fillStyle = player.color;
  ctx.beginPath();
  ctx.arc(0,0,22,0,2*Math.PI);
  ctx.fill();
  ctx.font = "32px Arial";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(CHARACTERS[gameSettings.player].emoji,0,3);
  if (player.shield) {
    ctx.beginPath();
    ctx.strokeStyle="#0ffb";
    ctx.lineWidth=4;
    ctx.arc(0,0,30,0,2*Math.PI);
    ctx.stroke();
  }
  ctx.restore();
}
function updatePlayer() {
  // Lane-Wechsel (Tastatur & Touch)
  // Sprung etc. w√§re f√ºr Erweiterung!
}
// ========== HINDERNISSE ==========
function spawnObstacle() {
  if (Math.random()<0.75) {
    obstacles.push({lane:Math.floor(Math.random()*3), y:-60, w:40, h:40});
  }
}
function updateObstacles() {
  if (runTime%40===0) spawnObstacle();
  for (let i=obstacles.length-1; i>=0; i--) {
    obstacles[i].y += runSpeed+level*0.4;
    // Collision
    if (Math.abs(obstacles[i].y-player.y)<32 && obstacles[i].lane===player.lane) {
      if (player.shield) { player.shield=false; obstacles.splice(i,1); SFX.crash.play(); }
      else gameOver();
    }
    if (obstacles[i].y>GAME_H+40) obstacles.splice(i,1);
  }
}
function drawObstacles() {
  for (const o of obstacles) {
    ctx.save();
    ctx.translate(lanes[o.lane], o.y);
    ctx.fillStyle = "#f44";
    ctx.fillRect(-o.w/2,-o.h/2,o.w,o.h);
    ctx.restore();
  }
}
// ========== M√úNZEN ==========
function spawnCoin() {
  if (Math.random()<0.5) {
    coinsArr.push({lane:Math.floor(Math.random()*3), y:-20, w:24, h:24});
  }
}
function updateCoins() {
  if (runTime%30===0) spawnCoin();
  for (let i=coinsArr.length-1; i>=0; i--) {
    coinsArr[i].y += runSpeed+level*0.5;
    // Magnet?
    let magnetActive = powerup==="Magnet"||powerup==="Jetpack";
    let px = lanes[player.lane], py = player.y;
    let cx = lanes[coinsArr[i].lane], cy = coinsArr[i].y;
    let dist = Math.abs(cx-px)+Math.abs(cy-py);
    if (magnetActive && dist<110) {
      // Coin an Spieler heran bewegen
      coinsArr[i].lane = player.lane;
      coinsArr[i].y += (player.y-coinsArr[i].y)*0.15;
    }
    // Collision
    if (Math.abs(coinsArr[i].y-player.y)<26 && coinsArr[i].lane===player.lane) {
      SFX.coin.play();
      collectedCoins += 1+(gameSettings.upgrades.coin||0);
      coinsArr.splice(i,1);
    }
    if (coinsArr[i] && coinsArr[i].y>GAME_H+30) coinsArr.splice(i,1);
  }
}
function drawCoins() {
  for (const c of coinsArr) {
    ctx.save();
    ctx.translate(lanes[c.lane],c.y);
    ctx.fillStyle = "#ffd700";
    ctx.beginPath();
    ctx.arc(0,0,12,0,2*Math.PI);
    ctx.fill();
    ctx.font="15px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillStyle="#b8860b"; ctx.fillText("üí∞",0,1);
    ctx.restore();
  }
}
// ========== POWERUPS ==========
function spawnPowerUp() {
  if (Math.random()<0.03) {
    let p = POWERUPS[Math.floor(Math.random()*POWERUPS.length)];
    powerupsArr.push({lane:Math.floor(Math.random()*3), y:-40, w:38, h:38, kind:p});
  }
}
function updatePowerUps() {
  if (runTime%180===0) spawnPowerUp();
  for (let i=powerupsArr.length-1; i>=0; i--) {
    powerupsArr[i].y += runSpeed+level*0.35;
    // Collision
    if (Math.abs(powerupsArr[i].y-player.y)<30 && powerupsArr[i].lane===player.lane) {
      SFX.powerup.play();
      powerup = powerupsArr[i].kind.name;
      powerupTimer = 200+(gameSettings.upgrades[powerupsArr[i].kind.key]||0)*90;
      if (powerup==="Shield") player.shield=true;
      powerupsArr.splice(i,1);
    }
    if (powerupsArr[i] && powerupsArr[i].y>GAME_H+40) powerupsArr.splice(i,1);
  }
  // Powerup Ablauf
  if (powerup) {
    powerupTimer--;
    if (powerupTimer<=0) {
      powerup=null;
      if (player) player.shield=false;
    }
  }
}
function drawPowerUps() {
  for (const p of powerupsArr) {
    ctx.save();
    ctx.translate(lanes[p.lane],p.y);
    ctx.fillStyle = p.kind.color;
    ctx.beginPath();
    ctx.arc(0,0,18,0,2*Math.PI);
    ctx.fill();
    ctx.font="22px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillStyle="#222"; ctx.fillText(p.kind.emoji,0,2);
    ctx.restore();
  }
}

// ========== EINFACHE STEUERUNG ==========
window.addEventListener("keydown", e => {
  if (!inGame || state!=="run") return;
  if (e.key==="ArrowLeft" && player.lane>0) player.lane--;
  if (e.key==="ArrowRight" && player.lane<2) player.lane++;
});
canvasBg.addEventListener("touchstart",e=>{
  if (!inGame || state!=="run") return;
  touchStartX = e.touches[0].clientX;
});
canvasBg.addEventListener("touchend",e=>{
  if (!inGame || state!=="run") return;
  let dx = e.changedTouches[0].clientX-touchStartX;
  if (dx<-30 && player.lane>0) player.lane--;
  if (dx>30 && player.lane<2) player.lane++;
});

// ========== ZUR√úCK ZUM MEN√ú ==========
document.getElementById("restart-btn").onclick = () => {
  SFX.button.play();
  startSubwaySurfer();
};
// Aus dem Spiel zur√ºck zum Men√º (optional)
document.addEventListener("keydown",e=>{
  if (e.key==="Escape" && inGame) {
    BGM.pause();
    inGame = false;
    document.getElementById("game-ui").style.display = "none";
    gameCanvas.style.display = "none";
    showMainMenu();
  }
});
</script>
